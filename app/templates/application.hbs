{{#labs-ui/site-header
  responsiveNav=true
  as |banner|
}}
  {{#banner.title}}
    {{#link-to 'application' classNames='site-title' }}Street Map <small class="site-subtitle show-for-medium"><span class="show-for-xlarge">The</span> Status &amp; History of N<span class="show-for-xlarge">ew </span>Y<span class="show-for-xlarge">ork </span>C<span class="show-for-xlarge">ity</span>&rsquo;s Streets</small>{{/link-to}}
  {{/banner.title}}
  {{#banner.nav}}
    <ul class="menu vertical large-horizontal">
      <li class="menu-list-item">
        {{link-to 'About' 'about' class="menu-list-item-link"}}
      </li>
      <li class="menu-list-item">
        {{link-to 'City Map' 'city-map' class="menu-list-item-link"}}
      </li>
      <li class="menu-list-item">
        {{link-to 'Data' 'data' class="menu-list-item-link"}}
      </li>
      <li class="menu-list-item">
        {{link-to 'Feedback' 'feedback' class="menu-list-item-link"}}
      </li>
    </ul>
  {{/banner.nav}}
{{/labs-ui/site-header}}

<div class="site-main grid-x route-{{currentRouteName}}">

  <div class="search-container">
    {{#labs-search
        onSelect=(action 'handleSearchSelect')
        onHoverResult=(action 'handleSearchResultHover')
        onHoverOut=(action 'handleSearchHoverOut')
        onClear=(action 'handleSearchClear')
        searchTerms=searchTerms
        typeTitleLookup=(hash
          lot='Addresses'
          city-street='Streets'
          city-map-alteration='Alterations and ULURP Numbers'
        ) as |search|}}
      {{#if (eq search.result.type 'lot')}}
        <span class="icon tax-lot"></span> <span class="subdued">{{search.result.label}}, Block {{search.result.demuxedBbl.block}}, Lot {{search.result.demuxedBbl.lot}}</span>
      {{else if (eq search.result.type 'city-street')}}
        {{search.result.label}} ({{search.result.boro_name}})
      {{else if (eq search.result.type 'city-map-alteration')}}
        {{search.result.label}} ({{moment-format search.result.effective 'DD MMMM YYYY'}})
      {{/if}}
    {{/labs-search}}
    {{labs-bbl-lookup flyTo=(action 'flyTo')}}
  </div>
  <div class="map-container cell medium-auto large-order-2">
    {{#labs-map
      id='main-map'
      initOptions=initMapOptions
      mapLoaded=(action 'handleMapLoad') as |map|}}

      {{#map.labs-layers
        onLayerMouseMove=(action 'handleLayerMouseMove')
        layerGroups=model.layerGroups as |layers|}}
        {{#layers.tooltip as |tooltip|}}
          {{tooltip-renderer feature=tooltip.feature template=tooltip.layer.tooltipTemplate}}
        {{/layers.tooltip}}
      {{/map.labs-layers}}

      {{#if (not-eq popupFeatures null)}}
        {{#map.popup
          lngLat=popupLocation}}
          {{map-popup-content
            onHoverListItem=(action 'handlePopupLinkOver')
            onMouseLeave=(action 'clearAmendmentHover')
            features=popupFeatures}}
        {{/map.popup}}

        {{#if highlightedAmendmentSource}}
          {{#map.source options=highlightedAmendmentSource as |source|}}
            {{source.layer layer=(hash
                type='line'
                paint=(hash
                  line-color="#ffff00"
                  line-opacity=0.6
                  line-width=12
                )
                layout=(hash
                  line-cap='round'
                )
              )
              before='boundary_country'
            }}
            {{source.layer layer=(hash
                type='line'
                paint=(hash
                  line-color="rgba(60, 133, 210, 1)"
                  line-opacity=1
                  line-width=(hash
                    stops = (array
                      (array 10 1.5)
                      (array 14 5)
                    )
                  )
                )
                layout=(hash
                  line-cap='round'
                )
              )
              before='boundary_country'
            }}
          {{/map.source}}
        {{/if}}
      {{else}}
        {{#map.popup lngLat=popupLocation}}
          {{fa-icon 'spinner' class='fa-spin medium-gray fa-3x fa-fw'}}
        {{/map.popup}}
      {{/if}}

      {{#if highlightedStreetSource}}
        {{#map.source options=highlightedStreetSource as |source|}}
          {{source.layer layer=(hash
              type='line'
              paint=(hash
                line-color="#ffff00"
                line-opacity=0.6
                line-width=12
              )
              layout=(hash
                line-cap='round'
              )
            )
            before='boundary_country'
          }}
          {{source.layer layer=(hash
              type='line'
              paint=(hash
                line-color="rgba(60, 133, 210, 1)"
                line-opacity=1
                line-width=(hash
                  stops = (array
                    (array 10 1.5)
                    (array 14 5)
                  )
                )
              )
              layout=(hash
                line-cap='round'
              )
            )
            before='boundary_country'
          }}
        {{/map.source}}
      {{/if}}

      {{#if highlightedAmendmentSource}}
        {{#map.source options=highlightedAmendmentSource as |source|}}
          {{source.layer layer=(hash
              type='line'
              paint=(hash
                line-color="#ffff00"
                line-opacity=0.6
                line-width=12
              )
              layout=(hash
                line-cap='round'
              )
            )
            before='boundary_country'
          }}
          {{source.layer layer=(hash
              type='line'
              paint=(hash
                line-color="rgba(60, 133, 210, 1)"
                line-opacity=1
                line-width=(hash
                  stops = (array
                    (array 10 1.5)
                    (array 14 5)
                  )
                )
              )
              layout=(hash
                line-cap='round'
              )
            )
            before='boundary_country'
          }}
        {{/map.source}}
      {{/if}}

      {{#if searchedAddressSource}}
        {{#map.source options=searchedAddressSource as |source|}}
          {{source.layer layer=(hash
              type='circle'
              paint=(hash
                circle-radius=8
                circle-color="#00A1F9"
                circle-stroke-width=2
                circle-stroke-color="#FFFFFF"
              )
            )
            before='boundary_country'
          }}
        {{/map.source}}
      {{/if}}

      {{map.on 'render' (action 'handleMapLoading')}}
      {{map.on 'data' (action 'handleMapLoading')}}
      {{map.on 'sourcedata' (action 'handleMapLoading')}}
      {{map.on 'click' (action 'handleMapClick')}}
      {{map.on 'move' (action 'handleMapPositionChange')}}
      {{map.on 'mousemove' (action 'handleLayerMouseMove')}}
      {{map.on 'drag' (action 'handleMapMouseDrag')}}
      {{map.on 'zoomend' (action 'handleMapPositionChange')}}

      {{#if loadStateTask.isRunning}}
        {{fa-icon 'spinner' class='fa-spin fa-3x map-loading-spinner'}}
      {{/if}}

      <a class="zola-map-area-button" href="https://zola.planning.nyc.gov/{{mapLatLngZoomHash}}" target="_blank" rel="noopener">
        <strong>View <span class="show-for-medium">this area</span> in ZoLa</strong>
        <small class="show-for-medium">NYCâ€™s Zoning &amp; Land Use Map</small>
      </a>
      {{#custom-controls
        shareURL=shareURL
        boundsGeoJSON=boundsGeoJSON}}
        <div class="print-controls mapboxgl-ctrl mapboxgl-ctrl-group">
          <button {{action 'handlePrint'}} class="mapboxgl-ctrl-icon">{{fa-icon 'print'}}</button>
        </div>
      {{/custom-controls}}

    {{/labs-map}}

  </div>

</div>